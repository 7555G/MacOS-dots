#!/usr/bin/env bash

# styling
BR_TEXT='\033[1;97m'
TEXT='\033[0m'

# usage
USAGE="Usage:\n    $(basename "$0") [-c] FILE COMMAND"

# parse arguments
has_clear="false"
args=()

for arg in "$@"; do
    case "${arg}" in
      "-h")
        echo -e "${USAGE}"
        exit 0
        ;;
      "-c")
        has_clear="true"
        shift 1
        ;;
      *)
        args+=("${arg}")
    esac
done

if [[ "${#args[@]}" -ne 2 ]]; then
    echo -e "${USAGE}"
    exit 1
fi

FILE_PATH="$(realpath "${args[0]}")"
COMMAND="${args[1]}"

# function that prints timestamp
timestamp() {
    echo "[$(date "+%T.%3N")]"
}

# function to execute command
function execute_cmd() {
    # kill internal processes on exit
    trap 'jobs -p | xargs kill &> /dev/null' EXIT INT

    # execute the command
    if [[ "${has_clear}" == "true" ]]; then
        clear
    fi

    echo -e "${BR_TEXT}========== $(timestamp) Executing ==========${TEXT}\n"

    if eval "${COMMAND}"; then
        echo -e "\n${BR_TEXT}========== $(timestamp) Finished ===========${TEXT}"
    else
        echo -e "\n${BR_TEXT}========== $(timestamp) Failed =============${TEXT}"
    fi

    echo -e "${BR_TEXT}$(timestamp) Watching \"${FILE_PATH}\"...${TEXT}"
}

function main() {
    local exec_pid
    local changed=false
    local t=0.4
    local l=0.1

    # exit script on ctrl-c
    trap 'echo -e "${BR_TEXT}$(timestamp) Interrupted${TEXT}" && exit 1' INT

    # execute command once first
    execute_cmd &
        exec_pid=$!

    # watch file for changes, terminate and re-execute
    while true; do
        # watch for changes...
        changed="$(fswatch "${FILE_PATH}" -1 --latency ${l})"
        echo "$(timestamp) File changed"

        # kill current execution
        kill ${exec_pid} &> /dev/null
        wait ${exec_pid} &> /dev/null

        # keep watching for ${timeout} seconds for further changes
        while [[ -n ${changed} ]]; do
            echo "$(timestamp) Waiting for further changes..."
            changed="$( \
                timeout --foreground ${t} \
                fswatch "${FILE_PATH}" --event "Updated" -1 --latency ${l})"
        done

        # execute command
        execute_cmd &
            exec_pid=$!
    done
}

main
